<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Slot Machine</title>
    <style>
    html {
        font-size: 3vw;
        overflow-x: hidden; /* Hide sidebars */
    }
    
    body {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-family: Arial, sans-serif;
      text-align: center;
      background: var(--tg-theme-bg-color, #1e1e1e);
      color: var(--tg-theme-text-color, white);
      margin: 0;
      user-select: none;
    }

    .slot-machine {
        width: 23.75rem;
        height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        padding: 1.667rem;
        border: .313rem solid #444;
        border-radius: .75rem;
        background-color: #222;
        color: whitesmoke;
        user-select: none;
    }

    .iridescent-machine {
        animation: iridescent-border 1.5s linear infinite;
        transition: border 0.3s;
    }

    .payoff-board {
        display: flex;
        flex-direction: column;
        font-size: 1.125rem;
        background: #1c1c1c;
        padding: .625rem;
        border-radius: .75rem;
        border: .125rem solid #333;
        margin-top: 1.875rem;
    }

    .row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-radius: .5rem;
        padding: .2rem .5rem;
        color: gray;
    }

    .payoff-board h3 {
        color: #ffcc00;
        margin: 0 0 .5rem 0;
    }

    .background-gold {
        animation: gold-shine 1.5s linear infinite;
    }

    @keyframes gold-shine {
        0%, 100% { background-color: #1c1c1c;}
        50% {background-color: gold;}
    }

    .border-gold {
        animation: gold-shine-bd 1.5s linear infinite;
    }

    @keyframes gold-shine-bd {
        0%, 100% { border-color: #1c1c1c;}
        50% {border-color: gold;}
    }

    .border-iridescent {
        animation: iridescent 1s linear infinite;
    }

    @keyframes iridescent {
        0% { border-color: red; }
        16% { border-color: orange; }
        33% { border-color: yellow; }
        50% { border-color: lime; }
        66% { border-color: cyan; }
        83% { border-color: blue; }
        100% { border-color: violet; }
    }

    .user-stats {
        display: flex;
        justify-content: space-between;
        font-size: 1.25rem;
    }

    .reels {
      display: flex;
      justify-content: space-between;
      gap: .5rem;
      margin-bottom: 30px;
      /* font-size: 80px; */
    }

    .reel {
      width: 6.875rem;
      height: 6.875rem;
      border: .25rem solid #555;
      background: #1c1c1c;
      border-radius: .75rem;
      display: flex;
      /* align-items: center; */
      justify-content: center;
      font-size: 4.8rem;
    }
    
    .buttons {
        display: flex;
        justify-content: space-between;
        /* margin-top: 2.5rem; */
        gap: .5rem;
    }

    button {
        flex: 1;
        padding: 1.25rem;
        font-size: 1.25rem;
        background-color: #28a745;
        border: none;
        border-radius: .75rem;
        cursor: pointer;
        touch-action: manipulation;
        min-width: 8.75rem;
        user-select: none;
    }

    button:enabled {
        animation:
            bg-breathe 3s ease-in-out infinite,
            font-breathe 3s ease-in-out infinite;
    }
    
    @keyframes bg-breathe {
        0%, 100% {background-color: darkgreen;}
        50% {background-color: limegreen;}
    }

    @keyframes font-breathe {
        0%, 100% {color: wheat;}
        50% {color: white;}
    }
    
    button:hover:not(:disabled) {
      background-color: #218838;
    }

    button:active:not(:disabled) {
      background-color: #1c6e30;
      transform: scale(0.98);
    }

    button:disabled {
        background-color: #555;
        color: darkgray;
        cursor: not-allowed;
    }

    /* .balance-numbers {
        display: inline-block;
        transition: transform 0.15s ease;
    } */

    #balanceNumbers {
        display: inline-block;
    }
    
    .pulse {
        animation: pulse-scale 100ms linear;
    }

    @keyframes pulse-scale {
        0% { transform: scale(2); }
        100% { transform: scale(1); }
    }

    #viewport-info {
        color: #555;
    }

    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 1000;
    }

    .modal-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    .modal {
      background: #222;
      padding: 30px 40px;
      border-radius: 16px;
      border: 3px solid #ffcc00;
      max-width: 320px;
      color: #ffcc00;
      font-size: 22px;
      text-align: center;
      box-shadow: 0 0 20px #ffcc00aa;
      position: relative;
      animation: modal-pop 0.35s ease forwards;
    }

    @keyframes modal-pop {
      0% { opacity: 0; transform: scale(0.7); }
      100% { opacity: 1; transform: scale(1); }
    }

    .modal button {
      margin-top: 20px;
      background: #ffcc00;
      border: none;
      color: #222;
      font-weight: bold;
      padding: 10px 24px;
      font-size: 18px;
      border-radius: 10px;
      cursor: pointer;
      transition: background-color 0.15s ease;
    }

    .modal button:hover {
      background: #e6b800;
    }
    
    </style>
</head>
<body>

<div class="slot-machine" id="slotMachine">
    <h1>üëë Slotty King üëë</h1>

    <div class="payoff-board">
        <h3>Payoff Board</h3>
        <div id="payoutRows"></div> <!-- Rows will go here -->
    </div>

    <div class="user-stats">
        <div>
            Balance: <span id="balanceNumbers"></span>
        </div>
        <div>
            Max payout: <span id="maxPayoutNumbers"></span>
        </div>
    </div>

    <div class="reels" id="reels">
        <div class="reel" id="reel1">üíé</div>
        <div class="reel" id="reel2">üíé</div>
        <div class="reel" id="reel3">üíé</div>
    </div>

    <div class="buttons">
        <button disabled id="spinBtn" onclick="spin()">SPIN <br><span style="font-size: 1rem;">10 credits</span></button>
        <button disabled id="cashBtn" onclick="cashOut()">CASH<br>OUT</button>
    </div>
    <span id="viewport-info"></span>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modalOverlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle" tabindex="-1">
  <div class="modal">
    <div id="modalTitle"></div>
    <button id="modalButton">OK</button>
  </div>
</div>

<script>
    // Switch to fullscreen in tg
    document.addEventListener('DOMContentLoaded', function () {
        if (window.TelegramWebviewProxy && typeof window.TelegramWebviewProxy.postEvent === 'function') {
            window.TelegramWebviewProxy.postEvent('web_app_request_fullscreen', null)
        } else {
            console.log("TelegramWebviewProxy not available. Running outside Telegram.");
        }
    });

    function updateViewportInfo() {
        document.getElementById('viewport-info').textContent =
        `Viewport size: ${window.innerWidth} x ${window.innerHeight}; @u002E`;
    }

    window.addEventListener('resize', updateViewportInfo);
    document.addEventListener('DOMContentLoaded', updateViewportInfo)

    const payoutData = {
        '3d': { symbols: 'üíé üíé üíé', amount: 70 },
        '3w': { symbols: 'üçâ üçâ üçâ', amount: 50 },
        '3c': { symbols: 'üçí üçí üçí', amount: 40 },
        '3b': { symbols: 'üîî üîî üîî', amount: 40 },
        '2w': { symbols: 'üçâ üçâ', amount: 30 },
        '2c': { symbols: 'üçí üçí', amount: 20 },
        '2b': { symbols: 'üîî üîî', amount: 20 },
        '1c': { symbols: 'üçí', amount: 10 }
    };
    
    const symbols = ['üçí', 'üîî', 'üçâ', 'üíé'];
    let balance = 0;
    let minBet = 10;
    let maxPayout = 0;
    let payoutRow;
    let isSpinning = false;

    const balanceNumbers = document.getElementById('balanceNumbers');
    const maxPayoutNumbers = document.getElementById('maxPayoutNumbers')
    const spinBtn = document.getElementById('spinBtn');
    const cashBtn = document.getElementById('cashBtn');
    const slotMachine = document.getElementById('slotMachine');
    const reelElems = document.getElementById('reels').children;

    const modalOverlay = document.getElementById('modalOverlay');
    const modalTitle = document.getElementById('modalTitle');
    const modalButton = document.getElementById('modalButton');

    function createPayoutRow(id, symbols, amount) {
        const row = document.createElement('div');
        row.className = 'row';
        row.id = id;

        const col1 = document.createElement('div');
        col1.className = 'col1';
        col1.textContent = symbols;

        const col2 = document.createElement('div');
        col2.className = 'col2';
        col2.textContent = amount;

        row.appendChild(col1);
        row.appendChild(col2);

        return row;
    }

    function renderPayoutBoard() {
        const container = document.getElementById('payoutRows');
        container.innerHTML = ''; // Clear previous (if any)

        for (const [id, { symbols, amount }] of Object.entries(payoutData)) {
            const row = createPayoutRow(id, symbols, amount);
            container.appendChild(row);
        }
    }

    function renderUserStats() {
        balanceNumbers.textContent = balance
        maxPayoutNumbers.textContent = maxPayout
    }

    document.addEventListener('DOMContentLoaded', () => {
        renderPayoutBoard();
        updateUserStats(100);
    });
  
    function getRandomSymbol() {
        return symbols[Math.floor(Math.random() * symbols.length)];
    }

    function calculatePayout([r1, r2, r3]) {
        if (r1 === 'üíé' && r2 === 'üíé' && r3 === 'üíé') return { rowId: '3d', payout: 70, jackpot: true, winningIndexes: [0, 1, 2] };
        if (r1 === 'üçí' && r2 === 'üçí' && r3 === 'üçí') return { rowId: '3c', payout: 40, winningIndexes: [0, 1, 2] };
        if (r1 === 'üçí' && r2 === 'üçí') return { rowId: '2c', payout: 20, winningIndexes: [0, 1] };
        if (r1 === 'üçí') return { rowId: '1c', payout: 10, winningIndexes: [0] };
        if (r1 === 'üîî' && r2 === 'üîî' && r3 === 'üîî') return { rowId: '3b', payout: 40, winningIndexes: [0, 1, 2] };
        if (r1 === 'üîî' && r2 === 'üîî') return { rowId: '2b', payout: 20, winningIndexes: [0, 1] };
        if (r1 === 'üçâ' && r2 === 'üçâ' && r3 === 'üçâ') return { rowId: '3w', payout: 50, winningIndexes: [0, 1, 2] };
        if (r1 === 'üçâ' && r2 === 'üçâ') return { rowId: '2w', payout: 30, winningIndexes: [0, 1] };
        return null;
    }

    function animateNumberIncrease(amount, step = 10) {
        return new Promise((resolve) => {
            if (!amount) {
                resolve(balance);
                return;
            }

            function pulseElement(element, vibrate = true) {
                element.classList.remove('pulse');
                void element.offsetWidth; // force reflow
                element.classList.add('pulse');
                if(vibrate) {navigator.vibrate?.(100);}
            }
        
            const increments = Math.floor(amount / step);
            let displayedBalance = balance;
            let count = 0;

            const interval = setInterval(() => {
                count++;
                displayedBalance += step;

                balanceNumbers.textContent = displayedBalance;
                pulseElement(balanceNumbers);
            
                if (count >= increments) {
                    clearInterval(interval);
                    balance = displayedBalance;
                    resolve(balance);
                }
            }, 200);
        });
    }
    
    function updateButtons(){
        spinBtn.disabled = balance < minBet || isSpinning;
        cashBtn.disabled = balance <= 100 || isSpinning;
    }
    
    async function updateUserStats(amount){
        if (balance === 0 && !amount) {
            showModal(`You're out of credits!`, true);
        }
        if (amount > 0) {
            balance = await animateNumberIncrease(amount);
            if (amount !== 100 && amount > maxPayout) {
                maxPayout = amount;
            }
        } else {
                balance += amount;
        }
        
        renderUserStats();
        updateButtons();
    }

    function removeAnimation() {
        // Removes border iridescence from machine
        slotMachine.classList.remove('border-iridescent');
        
        // Removes border iridiscence, gold-shine, from reels
        for (const reel of reelElems) {
            reel.classList.remove('border-iridescent', 'border-gold');
        }
        
        // Removes highlight from payout row 
        if (payoutRow) {
            payoutRow.classList.remove('background-gold');
        }
    };
    
    function spin() {
        function animatePayout(result){
            payoutRow = document.getElementById(result.rowId);
            payoutRow.classList.add('background-gold');

            // Lights reels
            if (result.winningIndexes.length === reelElems.length) {
                for (const reel of reelElems) {
                    reel.classList.add('border-iridescent');
                }
            }else{
                result.winningIndexes.forEach(i => {
                    reelElems[i].classList.add('border-gold');
                });
            }

            if (result.jackpot) {
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                slotMachine.classList.add('border-iridescent'); 
            }
        }
        
        if (balance < minBet || isSpinning) return;

        isSpinning = true
        
        removeAnimation()
        updateUserStats(-minBet);

        let finalSymbols = [];
        let finalSymbolsCollected = 0

        // Animate reels spinning
        for (const [index, reel] of [...reelElems].entries()) {
            let spinInterval = setInterval(() => {
                reel.textContent = getRandomSymbol();
            }, 100);

            setTimeout(() => {
                clearInterval(spinInterval);
                const final = getRandomSymbol();
                reel.textContent = final;
                finalSymbols[index] = final;
                finalSymbolsCollected ++
                if (finalSymbolsCollected === reelElems.length) {
                    isSpinning = false;
                    const result = calculatePayout(finalSymbols)
                    if (result) {
                        animatePayout(result)
                    }
                    updateUserStats(result? result.payout: null)           
                }
            }, 1000 + index * 300);
        }
    };

    function showModal(message, isZeroBalance = false) {
        modalTitle.textContent = message;
        modalOverlay.classList.add('active');
        modalButton.textContent = isZeroBalance ? "Get credit" : "OK";
        modalButton.onclick = () => {
            modalOverlay.classList.remove('active');
            if (isZeroBalance) {
                updateUserStats(100);
            }
        };
    };

    function cashOut() {
        if (balance > 100 && ! isSpinning) {
            showModal(`You cashed out with ${balance - 100} credits! üéâ`);
            updateUserStats(100 - balance);
            removeAnimation();
        }
    };
</script>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

</body>
</html>
